#!/usr/bin/python
##########################
# Author: A. Malapert                                    #
# Version: 0.1                                                  #
# Licence: GPL                                                #
##########################



##########################
# Import of external classes and functions

import StringIO
import re
import textwrap
import logging
import sys
from sets import Set
import argparse
        
        
colsep="|"; 
       
##########################
# Definition of functions         

def write_header(ostream, keys):
    global colsep;
    for key in keys:
        ostream.write("%10s%s" % ( key[key.strip().rfind(' ')+1:], colsep) )
    ostream.write('\n')

def write_entry(ostream, results, keys):
    global colsep;
    if len(results) == 0:
        logging.warning("Empty entry.")
    elif len(keys) != len(results):
        logging.warning("MISSING "+str(set(keys).difference(results.keys())))
    for key in keys:
        if results.has_key(key):
            ostream.write("%10s%s" % ( results[key], colsep))
        else:
            ostream.write("%10s%s" %  ('', colsep))
    ostream.write('\n')

def parse_entries(istream, ostream, keys):
    ## TODO Warning when overriding values
    ## TODO instance line
    results ={} 
    for line in istream:
        for key in keys:
            match=re.match(key, line);
            if match:
                if key in results: 
                    write_entry(ostream, results, keys)
                    results ={} 
                results[key]=line[match.end():].strip();
                break
    write_entry(ostream, results,keys)

##########################
# Definition of a main procedure 
if __name__ == "__main__":
    
    # Parse command line
    parser = argparse.ArgumentParser(
        formatter_class=argparse.RawDescriptionHelpFormatter,
        description=textwrap.dedent('''\
%(prog)s does something useful 
 '''),
        epilog=textwrap.dedent('''\

%(prog)s 0.1
Copyright (C) 2011 Arnaud Malapert (UNS CNRS).
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>.

Written by A Malapert
''')
        );
    parser.add_argument('-v','--version', action='version', version='%(prog)s 0.1')
    parser.add_argument('--verbose', action='store_true',help="increase verbosity")
    parser.add_argument('-k', '--keys', type=argparse.FileType('r'), help="text file containing the keys searched in .o files.",required=True) 
    parser.add_argument('-i', '--input', type=argparse.FileType('r'),nargs='+',help=".o files of solvers",required=True)
    parser.add_argument('-o', '--output', type=argparse.FileType('w'), help="output text file (Table with all results)") 
    parser.add_argument('-c', '--colsep',help="column separator for the table)") 
    ## TODO
    parser.add_argument('-n', '--noheader', action='store_true', help="no row or column header in the table") 
    args=parser.parse_args()

    logging.basicConfig(format='%(levelname)s: %(message)s')

    if args.verbose:
        logging.getLogger().setLevel(logging.DEBUG)

    if args.colsep:
        colsep=args.colsep
        logging.debug("SET column separator to '%s'" % colsep)

    ## Read keys from a file
    keys=[];
    for key in args.keys:
        key=key.strip()+' ';
        if len(key)>1 and key not in keys : keys.append(key)
    print keys
    args.keys.close();

    ## Initialize output file
    extre = re.compile('\.[^\.]+$');
    if args.output :
        outfile = args.output
        logging.debug("WRITE %s" % outfile.name) 
        if not args.noheader: write_header(outfile,keys)
    else :
        outfile=None
    ## Read and extract Table from log files
    for infile in args.input:
        if not args.output :
            if outfile : outfile.close();
            fname=extre.sub('.res',infile.name);
            outfile = open(fname, 'w')
            if not args.noheader: write_header(outfile,keys)
        logging.debug("READ %s" % infile.name)
        parse_entries(infile,outfile,keys)
        infile.close()
    if outfile : outfile.close();

    

    




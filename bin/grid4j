#!/bin/sh
###################################################
#     Copyright (C) 2011 Arnaud Malapert.
#
#     This program is free software: you can redistribute it and/or modify                    
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
#
#     This program is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
#
#     You should have received a copy of the GNU General Public License
#     along with this program.  If not, see <http://www.gnu.org/licenses/>.
###################################################

PROG=`basename $0 .sh`
version() {

cat << EOF
$PROG 0.1
     
Copyright (C) 2011 Arnaud Malapert.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>.
This  is free software: you are free to change and redistribute it.  There is NO WARRANTY, to the extent permitted by law.
EOF
}

help() {
cat << EOF
$PROG deploys a benchmark for a java solver in the current directory.
The directory DIR describes the structure of the benchmark. The directory 'instances' contains all benchmark instances. A set of properties file describes the different configurations of the solver.
A jar file contains an executable solver which accepts at least two parameters : -p property ; -f file. 
The deployement occurs only when the filename of an instance matches the regular expression PATTERN. 

Usage: $PROG [OPTION]... DIR PATTERN...
     
Options:
  -j options       pass options to jvm            
  -p options      pass options to the java program
  -d      activate the headless jvm option

  -h      display this help and exit
  -v      output version information and exit
     
Examples:
$PROG ./ '*.txt' 
     
Report bugs to < arnaud (dot) malapert (at) unice (dot) fr>."
EOF
}

#--------------------------------------------------------------------
# Setup Global Variables
#--------------------------------------------------------------------

INST="instances" #the sub-directory of $DIR which contains all instance files
HEADLESS_OPTION=
JVM_OPTIONS="-server -Xms512m -Xmx1024m"
PROGRAM_OPTIONS="-v QUIET"

#--------------------------------------------------------------------
# Test for prerequisites
#--------------------------------------------------------------------


while getopts “hvdj:p:” OPTION
do
    case $OPTION in
        h)
	    help
	    exit
            ;;
	v)
	    version
	    exit
            ;;
        d)
	    HEADLESS_OPTION="-Djava.awt.headless=true";
            ;;
        j)
             JVM_OPTIONS=$OPTARG
             ;;
         p)
            PROGRAM_OPTIONS=$OPTARG
            ;;
         ?)
             help
             exit 1
             ;;
     esac
done

shift $(($OPTIND - 1))
if [ $# -lt 2 ] ; then
    help
    exit 1;
fi


#--------------------------------------------------------------------
# Do something
#--------------------------------------------------------------------

if [  -d $1 ]; then
    DIR=$1;
    cd $DIR;
    shift;
    if [ -d $INST ]; then
	JAR=`ls *.jar` #a single jar file
	for PROP in `ls *.properties`; do
	    CDIR=${PROP/%.properties/} #remove the extension
	    gridbench $INST $CDIR $PROP $JAR #create benchmark directories
	    for PATTERN in "$@" ; do 
	    gridjobs $CDIR "$PATTERN" "java $JVM_OPTIONS $HEADLESS_OPTION -jar $JAR   $PROGRAM_OPTIONS -p $PROP -f {}" #create benchmarking shell scripts
	    done
	done
    else
	echo "$INST is not a directory."
    fi
else
    echo "$1 is not a directory."
fi



#!/bin/sh
###################################################
#     Copyright (C) 2013 Arnaud Malapert (UNS CNRS).
#
#     This program is free software: you can redistribute it and/or modify                    
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
#
#     This program is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
#
#     You should have received a copy of the GNU General Public License
#     along with this program.  If not, see <http://www.gnu.org/licenses/>.
###################################################


#--------------------------------------------------------------------
# Setup Global Variables
#--------------------------------------------------------------------

PROG=`basename $0 .sh`
ALGORITHMS=algorithms
INSTANCES=instances
RESULTS=results
SOLVER=./solver.sh;

ERRFILE=oar-stderr.log

#Option arguments
PATTERN='*.txt'
RANDOMSEED=$$
SUBMODE=0

#--------------------------------------------------------------------
# Version and help messages
#--------------------------------------------------------------------

version() {
cat <<EOF
$PROG 0.2
     
Copyright (C) 2013 Arnaud Malapert (UNS CNRS).
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>.
EOF
}

help() {
cat <<EOF
$PROG generates new jobs for the batch scheduler OAR. $PROG operates in the current directory.
For each solver configuration file in the flat directory $ALGORITHMS, and for each file matching the pattern in the subdirectories of $INSTANCES, $PROG submits a new job based on the shell script $SOLVER.

All error outputs are redirected to the file $ERRFILE.
For each algorithm and each instance file, the standard output is redirected to a .o file in the directory $RESULTS.

Usage: $PROG [OPTION]... 

Options:
 -p 'PATTERN'     filename pattern for instances   
 -s  SEED         random seed  
 
 -l        serial submission on localhost
 -g        grid submission with OAR
 -d        only print submission with OAR (debug)

 -h        display this help and exit
 -v        output version information and exit
     
Report bugs to <arnaud (dot) malapert (at) unice (dot) fr>."
EOF
}


#--------------------------------------------------------------------
# Test for prerequisites
#--------------------------------------------------------------------



while getopts ":p:s:gldhv" opt; do
    case $opt in
        p)
            PATTERN=$OPTARG
            ;;
        s)
            SEED=$OPTARG
            ;;
        g)
            SUBMODE=0
            ;;
        l)
            SUBMODE=1
            ;;
       d)
            SUBMODE=2
            ;;
        h)
            help 
            exit 0
            ;;
        v)
            version;
            exit 0
            ;;
        \?)
            echo "Invalid option: -$OPTARG" >&2
            exit 1
            ;;
        :)
            echo "Option -$OPTARG requires an argument." >&2
            exit 1
            ;;
    esac
done


#--------------------------------------------------------------------
# Do something
#--------------------------------------------------------------------


if [  $SUBMODE -eq 0 ] || [ $SUBMODE -eq 1 ] ; then
    rm -fr $RESULTS $ERRFILE
    mkdir $RESULTS

# ####################################
# copy instance directory struture into a temporary directory
    TMPDIR=`mktemp -d`
    find  $INSTANCES/  -type d -print0 | while read -d $'\0' FILE
    do
        mkdir -p $TMPDIR/${FILE#$INSTANCES/}
    done

###############################
# copy instance directory struture for each algorithm
    for ALGO in `ls $ALGORITHMS` ; do
        ALGODIR=$RESULTS/${ALGO%.*}
        cp -a $TMPDIR $ALGODIR
    done
    
    rm -fr $TMPDIR
fi  



# submit the resolution of each instance by each algorithm.
find  $INSTANCES  -name "$PATTERN" -print0 | while read -d $'\0' BENCHPATH
do
    for ALGOPATH in `ls $ALGORITHMS/*` ; do
        ADIR=`basename $ALGOPATH`;
        OUTFILE=${BENCHPATH%.*}.o
        OUTFILE=${OUTFILE#$INSTANCES/} 
        OUTFILE=$RESULTS/${ADIR%.*}/$OUTFILE
        JOBCMD="$SOLVER $ALGOPATH $BENCHPATH $RANDOMSEED"
        OARCMD="oarsub --stderr $ERRFILE --stdout $OUTFILE -S "
        case $SUBMODE in 
            ## OAR submission on a cluster
            0) $OARCMD "$JOBCMD";;
           ##serial submission on localhost
            1) $JOBCMD > $OUTFILE 2>> $ERRFILE;;
            ## debug mode (only print command)
            *) echo $OARCMD "$JOBCMD";;
	    esac
    done
done



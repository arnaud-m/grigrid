#!/usr/bin/octave -qf
###################################################
#     Copyright (C) 2011 Arnaud Malapert.
#
#     This program is free software: you can redistribute it and/or modify                    
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
#
#     This program is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
#
#     You should have received a copy of the GNU General Public License
#     along with this program.  If not, see <http://www.gnu.org/licenses/>.
###################################################


1; #not a function file

##--------------------------------------------------------------------
## Setup variables and functions
##--------------------------------------------------------------------

 global VERSION="0.1"

 function _version()
   global VERSION;
   printf("%s %s\n", program_name(), VERSION);
   disp("Copyright (C) 2011 Arnaud Malapert");
   disp("License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>.");
   disp("This  is free software: you are free to change and redistribute it.  There is NO WARRANTY, to the extent permitted by law.");
 endfunction

function _help()
  printf("%s check that objective values are consistent across multiple results files.", program_name());
    disp("It requires at least two result files.")
  
  disp("\n\tUsage: gridlplot [OPTION]... RES... \n")
  disp("Options:")
  disp("\t--help        display this help and exit")
  disp("\t--version     output version information and exit");
          
  disp("\n\nReport bugs to <malapert (at) i3s (dot) unice (dot) fr>.")
endfunction


##--------------------------------------------------------------------
## Test for prerequisites
##--------------------------------------------------------------------
args = argv ();
if( nargin > 0)
  if(strcmp(args{1},"--version"))
    _version();
    exit(0);
  elseif(strcmp(args{1},"--help"))
    _help();
    exit(0);
  endif
endif

if(nargin<2)
  _help();
  error("This octave script takes at least two argument.");
endif

source('~/.grigrid/libgrigrid.m');
##--------------------------------------------------------------------
## Do something
##--------------------------------------------------------------------

args=argv();
cpt=0;
##Loop over result files and generate gnuplot data
M=fread(args{1});
R =  [ - inf(size(M,1), 1) inf(size(M,1), 1)] ;
 for i = 1:nargin
   M=fread(args{i});
   ##Optimums
   O= findOPT(M);
   if( any( R(O, 1) > M(O, OBJ) ) )
     error "Lower Bound vs Optimal"
   endif
   if( any( R(O, 2) < M(O, OBJ) ) )
     error "Upper Bound vs Optimal"
   endif
   R(O, [1 2]) = M(O, [ OBJ OBJ] );
   ##Satisfiable
   S=findSAT(M);
   if( any( R(S, 1) > M(S, OBJ) ) )
     error "Lower Bound vs Upper Bound"
   endif
   if( any( R(S, 2) < M(S, LB) ) )
     error "Upper Bound vs Lower Bound"
   endif
   SLB = S( find(R(S, 1) <  M(S, LB)));
   R( SLB, 1) = M(SLB, LB );
   SUB = S( find(R(S, 2) >  M(S, OBJ)));
   R( SUB, 2) = M(SUB, OBJ );
 endfor
   if( any( R(:, 1) > R(:,2) ) )
     error "Final results are not consistent"
   endif
   tempfile1 = tempname ();
   system(cstrcat("awk '{if($NL>0) print $1}' ", args{1}, "  > ", tempfile1));
   tempfile2 = tempname ();
   myfile=fopen(tempfile2,"w");
   for i = 1:size(R,1)
     if(R(i,1) == R(i,2))
       fprintf(myfile,"%d\n",R(i,1));
     else
       fprintf(myfile,"%d:%d\n",R(i,1), R(i,2));
     endif
   endfor
   fclose(myfile);
   system(cstrcat("paste -d = " , tempfile1, " ", tempfile2, " > summary.properties" ));
